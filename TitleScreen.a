MusicInit = MusicPlayerInit
MusicPlay = MusicPlayerPlay
TableColumn1 = $d9ea 
TableSize1 = $03
TableColumn2 = $d9ee 
TableSize2 = $09
TableColumn3 = $d9f8
TableSize3 = $06

; The memory map for this title screen displays graphics data in bank 0
; $0400-$07ff - Screen
; $0800-$0fff - Char data
; $1000-$bfff - Code and data
; $c000-$ffff - Unused by the title screen and contains graphics data for the game.
!zn
MessageScrollX !by 0
DisplayTitleScreen
	lda #0
	sta pagedelay
	sta firebutton
	sta colourdelay
	sta colourpointer 
	lda #1
	sta pagevalue
   
    ldx #$00
ClearSID 
    ldx #$00
clearit 
    lda #$00
    sta $d400,x 
    inx 
    cpx #$18 
    bne clearit        

	lda #6
	sta $d020 
	sta $d021
	
	+ClearScreenAt_AX COLOURRAM , VIC2Colour_Black
   

	; Just to make sure we disable interrupts.
	; This title screen code can use the multiplexor and animation engine if it wants to
	sei
	; Stop any NMI from its timers. NMIs generated by other sources are ignored by the NMI routine.
	lda #$7f
	sta CIA2InterruptControl
	lda #0
	sta CIA2TimerAControl
	sta CIA2TimerBControl
	; Ack any interrupts that might have happened
	lda CIA2InterruptControl

	jsr TitleScreenWaitForOffScreenFromRaster
	; Turn off the screen and sprites
	lda #0
!ifdef Scroller_DisplayTitleScreen {
	sta TitleScreen_Enable_ScrollerDemoWait_Hooks
}
	sta VIC2ScreenControlV
	sta VIC2SpriteEnable
!ifdef Multiplex_LogCollisions {
!ifdef Multiplexor_UpdateCollisionDetailsSoftEnable {
	sta Multiplexor_UpdateCollisionDetailsSoftEnableFlag
}
}
	; Init music
!ifdef Scroller_NoMusic {} else {
	lda #0
	jsr MusicPlayerInit
}
	
!ifdef Scroller_LOTD {
	lda #<ScrollText
	sta smMessageReadPos+1
	lda #>ScrollText
	sta smMessageReadPos+2
}
	lda #%1000
	sta VIC2ScreenControlH
	lda #%11
	sta CIA2PortASerialBusVICBank

	jsr DelayRoutine
	
	; Copy the SEUCK title screen data to the relevant places in VIC bank 0
	ldx #0
.loop0001
	lda TitleScreenCharData,x
	sta $0800,x
	lda TitleScreenCharData+$100,x
	sta $0900,x
	lda TitleScreenCharData+$200,x 
	sta $0a00,x 
	lda TitleScreenCharData+$300,x 
	sta $0b00,x
	lda TitleScreenCharData+$400,x 
	sta $0c00,x
!ifdef TitleScreen_AnimatingSprites {
	lda TitleScreenBallSprites,x
	sta $0a00,x
	lda TitleScreenBallSprites+$100,x
	sta $0b00,x
}
	inx 
	bne .loop0001
	
	;Clear the screen 
	jsr clearscreen

	;Check which sequence the program should run.

	;0 = title screen 
	;1 = game over 
	;2 = game complete

	lda sequence 
	cmp #1
	beq dogameover
	cmp #2 
	beq doendsequence
	jmp TitleMain

dogameover 
	jmp GameOverScreen
doendsequence 
	jmp EndScreen	
TitleMain 	
	;Draw title screen logo 

	ldx #$00
drawlogo 
	lda logomatrix,x 
	sta $0400,x 
	lda logomatrix+40,x 
	sta $0400+1*40,x 
	lda logomatrix+80,x 
	sta $0400+2*40,x 
	lda logomatrix+120,x 
	sta $0400+3*40,x 
	lda logomatrix+160,x 
	sta $0400+4*40,x 
	lda logomatrix+200,x 
	sta $0400+5*40,x 
	lda logomatrix+240,x 
	sta $0400+6*40,x 
	lda logomatrix+280,x 
	sta $0400+7*40,x 
	inx 
	cpx #40 
	bne drawlogo 
	jsr MakeCredits	
	ldx #$00
fillscrollcolour
	lda #$01
	sta $dbc0,x 
	inx 
	cpx #$28
	bne fillscrollcolour
	lda #$01
	sta $d022
	lda #$0e
	sta $d023

	lda #$0e 
	sta $dbc0 
	sta $dbc1 
	sta $dbe7
	sta $dbe6
	lda #$03
	sta $dbc2 
	sta $dbe5 

	lda #$1b
	sta $d011

	lda #$06
	sta $d020
	sta $d021

	lda #$18
	sta $d016

			lda #$34
            sta $07f8
            lda #$35 
            sta $07f9
            lda #$ff
            sta $d015 
            sta $d01c
            sta $d01b
           
			ldx #$00
fetchsprites 
			lda OptionSpriteData,x 
			sta $0d00,x 
			inx 
			cpx #$80 
			bne fetchsprites			

			 ldx #$00
setspritepos 
            lda postable,x 
            sta objpos,x 
            inx 
            cpx #$10
            bne setspritepos 

	; Display the data just copied.
	lda #%00011011
	sta VIC2ScreenControlV

	lda #%00010010
	sta VIC2MemorySetup

	; Initialise the multiplexor, animation engine and IRQs for the title screen code to use if it wants to
	; MPi: TODO: Init sprite multicolour mode and extended colours here
	lda #7
	jsr Multiplex_SetSpritePointer
	lda #Multiplex_items
	sta Multiplex_MaxSpr
	jsr Multiplex_InitSort
	jsr AnimationInit
	jsr AnimationClearMultiplexor
	lda #$ff
	sta VIC2SpriteMulticolour
	lda #VIC2Colour_White
	sta VIC2ExtraSpriteColour1
	lda #VIC2Colour_DarkGrey
	sta VIC2ExtraSpriteColour2

	ldx #Multiplex_items-1
.fl1
	txa
;	lda #VIC2Colour_Grey
	sta Multiplex_Colour,x
	lda #0
	sta Multiplex_XPosHi,x
	lda #$28	; Some sprite frame for now
	sta Multiplex_SpriteFrame,x
	lda Multiplex_YPos,x
!ifdef Multiplex_SplitSort {
	sta AnimationYPosToSort,x
}
	dex
	bpl .fl1

	jsr Multiplex_Sort
!ifdef Multiplex_SplitSort {
	jsr CopyMultiplexTables
}
 lda #$00
            sta $d025 
            lda #$0f 
            sta $d026         
    lda #$0f 
    jsr MusicInit+6
	jsr TitleScreenIRQNew
    

	;jsr SetupIRQsForTitleScreen

	; Now the loop which displays the title screen
.l3
!ifdef Scroller_LOTD {
	; MPi: TODO: Turn this into an IRQ split
	jsr TitleScreenWaitForMessageRaster
!ifdef Scroller_DebugMainlineBorder {
	inc VIC2BorderColour
}
}

	jsr ScrollerDemoWaitScorePanel
!ifdef Scroller_DebugMainlineBorder {
	inc VIC2BorderColour
}
!ifdef Scroller_NoMusic {} else {
	jsr MusicPlayerPlay
.skipMusicThisFrame
}
!ifdef Scroller_DebugMainlineBorder {
	inc VIC2BorderColour
}

!ifdef Scroller_LOTD {
	lda #8
	sta VIC2ScreenControlH
}

!ifdef Scroller_DebugMainlineBorder {
	inc VIC2BorderColour
}

!ifdef Scroller_LOTD {
	jsr ScrollMessageUpdate
}

!ifdef Scroller_DebugMainlineBorder {
	lda #0
	sta VIC2BorderColour
}
!ifdef TitleScreen_AnimatingSprites {
	lda #VIC2Colour_Red
	sta VIC2ScreenColour
} else {
	; Use the raster tale colour type to calculate the index into the colour table
;	lda RasterColourTableType
;	sec
;	sbc #$10
;	asl
;	asl
;	asl
;	clc
;	adc #<RasterColourTable
;	sta tempWork0

;	lda #>RasterColourTable
;	adc #0		; And carry any remaining from the above add
;	sta tempWork1

	; Update the table scroll counter every four frames
;.sm1	ldy #0
;.sm2	lda #0
;	bne .noUpdate
;	inc .sm1+1
;	lda .sm1+1
;	and #7
;	sta .sm1+1
;	lda #3
;	sta .sm2+1
;.noUpdate
;	dec .sm2+1
	; Wait for the top of the character data to start the raster effect
;	ldx #50+(6*8)
;.l5
;	lda RasterColourTableType
;	cmp #$10
	; If we are not doing a raster effect then just use the colour
;	bcc .l6
;	lda (tempWork0),y
;.l6
;	cpx VIC2Raster
;	bne .l6
;	sta VIC2ScreenColour
;	inx
;	inx
!ifdef Scroller_LOTD {
;	dey
} else {
;	iny
}
;	tya
;	and #7
;	tay
;	cpx #50+(20*8)
;	bne .l5
}

;Our main title screen loop 

TitleLoop 
	jsr SyncTimer 
	jsr ExpandMSB
	jsr ColourCycle
	jsr Scroller 
	jsr PageFlipper 
	jsr Wobbler 
	jsr JoystickControl
	jsr FlashTest 
	jsr TestSoundOption
    lda #16
    bit $dc01 
    bne TitleLoop 
    jmp InitGame
	jmp TitleLoop 

;Synchronize timer 

SyncTimer
	lda #0
	sta rt 
	cmp rt 
	beq *-3 
	rts 



;Expand sprite MSB position for options icons 
;Expand Sprite MSB position 

ExpandMSB
            ldx #$00
msbloop     lda objpos+1,x 
            sta $d001,x 
            lda objpos,x 
            asl 
            ror $d010
            sta $d000,x 
            inx 
            inx 
            cpx #$10
            bne msbloop 
            rts 


;Smooth X-Scrolling message 

Scroller    lda xpos 
            sec 
SCROLLSPEED
            sbc #2
            and #$07 
            sta xpos 
            bcs exitscroll

            ldx #$00
pullcol     lda $07c1,x 
            sta $07c0,x 
            inx 
            cpx #$27
            bne pullcol

messread    lda scrolltext
            bne storechr 
            lda #<scrolltext
            sta messread+1
            lda #>scrolltext 
            sta messread+2
            jmp messread

storechr    sta $07c0+39
            inc messread+1
            bne exitscroll
            inc messread+2
exitscroll  rts                        
                                              
;Page flipper control 


PageFlipper 
            inc pagedelay
            lda pagedelay
            beq flipnext 
            rts 
flipnext    inc pagedelay+1
            lda pagedelay+1
            cmp #2
            beq movenextpage
            rts 
movenextpage
            lda #0
            sta pagedelay 
            sta pagedelay+1
            lda pagevalue
            beq displaycredits 
            cmp #1
            beq displayhi1
            cmp #2
            beq displayhi2
            rts 

displaycredits 
            lda #1 
            sta pagevalue 
            jmp MakeCredits
displayhi1  lda #2
            sta pagevalue 
            jmp MakeHiScore1
displayhi2  lda #0 
            sta pagevalue 
            jmp MakeHiScore2 

            

            
;Credits page 

MakeCredits
            ldx #$00
docredits   lda CreditsText,x 
            sta $0400+10*40,x 
            lda CreditsText+1*40,x 
            sta $0400+11*40,x 
            lda CreditsText+2*40,x 
            sta $0400+12*40,x 
            lda CreditsText+3*40,x 
            sta $0400+13*40,x 
            lda CreditsText+4*40,x 
            sta $0400+14*40,x 
            lda CreditsText+5*40,x 
            sta $0400+15*40,x 
            lda CreditsText+6*40,x 
            sta $0400+16*40,x 
            lda CreditsText+7*40,x 
            sta $0400+17*40,x 
            lda CreditsText+8*40,x 
            sta $0400+18*40,x 
            lda CreditsText+9*40,x 
            sta $0400+19*40,x 
            lda CreditsText+10*40,x 
            sta $0400+20*40,x 
            lda #$20 
            sta $0400+21*40,x 
;Set colour for each row 

            lda #$01
            sta $d800+10*40,x 
            sta $d800+11*40,x 
            sta $d800+12*40,x 
            sta $d800+13*40,x 
            sta $d800+14*40,x 
            sta $d800+15*40,x 
            sta $d800+16*40,x 
            sta $d800+17*40,x 
            sta $d800+18*40,x 
            sta $d800+19*40,x 
            sta $d800+20*40,x 
            sta $d800+21*40,x
            inx 
            cpx #40 
            beq creditsdone
            jmp docredits
creditsdone    
            rts 

;Make Hi Score table - Player 1            

MakeHiScore1
            ldx #$00
dohi1       lda HiScoreText1,x 
            sta $0400+10*40,x 
            lda HiScoreText1+1*40,x 
            sta $0400+11*40,x 
            lda HiScoreText1+2*40,x 
            sta $0400+12*40,x 
            lda HiScoreText1+3*40,x 
            sta $0400+13*40,x 
            lda HiScoreText1+4*40,x 
            sta $0400+14*40,x 
            lda HiScoreText1+5*40,x 
            sta $0400+15*40,x 
            lda HiScoreText1+6*40,x 
            sta $0400+16*40,x 
            lda HiScoreText1+7*40,x 
            sta $0400+17*40,x 
            lda HiScoreText1+8*40,x 
            sta $0400+18*40,x 
            lda HiScoreText1+9*40,x 
            sta $0400+19*40,x 
            lda HiScoreText1+10*40,x 
            sta $0400+20*40,x 
            lda HiScoreText1+11*40,x 
            sta $0400+21*40,x

            lda #$06 
            sta $d800+10*40,x 
            sta $d800+11*40,x 
            sta $d800+12*40,x 
            sta $d800+13*40,x 
            sta $d800+14*40,x 
            sta $d800+15*40,x 
            sta $d800+16*40,x 
            sta $d800+17*40,x 
            sta $d800+18*40,x 
            sta $d800+19*40,x 
            sta $d800+20*40,x 
            sta $d800+21*40,x
            inx 
            cpx #$28
            beq hi1finished
            jmp dohi1
hi1finished             
            rts


MakeHiScore2 
            ldx #$00
dohi2       lda HiScoreText2,x 
            sta $0400+10*40,x 
            lda HiScoreText2+1*40,x 
            sta $0400+11*40,x 
            lda HiScoreText2+2*40,x 
            sta $0400+12*40,x 
            lda HiScoreText2+3*40,x 
            sta $0400+13*40,x 
            lda HiScoreText2+4*40,x 
            sta $0400+14*40,x 
            lda HiScoreText2+5*40,x 
            sta $0400+15*40,x 
            lda HiScoreText2+6*40,x 
            sta $0400+16*40,x 
            lda HiScoreText2+7*40,x 
            sta $0400+17*40,x 
            lda HiScoreText2+8*40,x 
            sta $0400+18*40,x 
            lda HiScoreText2+9*40,x 
            sta $0400+19*40,x 
            lda HiScoreText2+10*40,x 
            sta $0400+20*40,x 
            lda HiScoreText2+11*40,x 
            sta $0400+21*40,x 
            lda #$06
            sta $d800+10*40,x 
            sta $d800+11*40,x 
            sta $d800+12*40,x 
            sta $d800+13*40,x 
            sta $d800+14*40,x 
            sta $d800+15*40,x 
            sta $d800+16*40,x 
            sta $d800+17*40,x 
            sta $d800+18*40,x 
            sta $d800+19*40,x 
            sta $d800+20*40,x 
            sta $d800+21*40,x
            inx 
            cpx #$28
            beq hi2done 
            jmp dohi2 
hi2done     rts            


Wobbler     lda d016table+79 
            sta $f0 
            ldx #79
dowobble    lda d016table-1,x 
            sta d016table,x 
            dex
            bpl dowobble
            lda $f0
            sta d016table
            rts

;Joystick control 

JoystickControl
            jsr Joy1Read 
            jsr Joy2Read
            rts

Joy1Read             
            lda $dc00 
            lsr 
            lsr 
            lsr 
            lsr 
            lsr 
            bcs nojoyp2
            jmp GetReadyMode 
nojoyp2     rts           

Joy2Read    lda $dc01 
            lsr 
            lsr 
            lsr
            lsr 
            lsr 
            bcs nojoyp1             
            jmp GetReadyMode 
nojoyp1     rts 

GetReadyMode 
    lda #0
    sta $d015
    jsr fadeoutmode
            lda #$0f 
            jsr MusicPlayerInit+6

            lda #3      ;Get Ready jingle
            jsr MusicPlayerInit

            lda #$00
            sta SCROLLSPEED+1
            sta $d015
            jsr ClearScreen
CopyGetReadyText 
            lda GetReadyText,x 
            sta $05e0,x 
            lda #$0d 
            sta $d9e0,x 
            inx 
            cpx #$28
            bne CopyGetReadyText
            lda #$00
            sta firebutton
GetReadyLoop 
            jsr SyncTimer
            jsr ColourCycle
            ldx #$00
copygrcol  lda colourstore2
            sta $d9e0,x 
            inx 
            cpx #$28 
            bne copygrcol                        
            lda $dc00
            lsr
            lsr
            lsr
            lsr 
            lsr 
            bit firebutton
            ror firebutton
            bmi joyp1gr 
            bvc joyp1gr
            jsr KillIRQ
			lda #$00
			sta $d01b
            jmp .joystick0start
joyp1gr 
            lda $dc01
            lsr
            lsr
            lsr 
            lsr 
            lsr 
            bit firebutton
            ror firebutton
            bmi joyignore
            bvc joyignore
           
            jsr KillIRQ
			lda #$00
			sta $d01b
            lda #1
            jmp .joystick1start
joyignore   jmp GetReadyLoop                    



;Colour cycling routines 

ColourCycle
            lda colourdelay 
            cmp #2
            beq colourflashsetup 
            inc colourdelay 
            rts 
colourflashsetup 
            lda #0 
            sta colourdelay 
            ldx colourpointer
            lda ColourTable1,x 
            sta colourstore1
            lda ColourTable2,x 
            sta colourstore2
            lda ColourTable3,x 
            sta colourstore3 
            lda ColourTable4,x 
            sta colourstore4
            
            inx 
            cpx #8
            beq resetcolourflash
            inc colourpointer 
            jsr maketemproll
            rts 
resetcolourflash 
            ldx #0
            stx colourpointer 
            

maketemproll 
            lda colourstore1
            sta ColourTempTable1+7
            lda colourstore2 
            sta ColourTempTable2+7
            lda colourstore3 
            sta ColourTempTable3+7
            ldx #$00
upit        lda ColourTempTable1+1,x 
            sta ColourTempTable1,x 

            lda ColourTempTable2+1,x 
            sta ColourTempTable2,x 

            lda ColourTempTable3+1,x 
            sta ColourTempTable3,x 

            inx 
            cpx #$07
            bne upit
            rts 

;Test flash value. If pagevalue = 1 or 2 then flash the hi score columns

FlashTest   lda pagevalue 
            cmp #1
            beq noflashing
            jmp flashhiscoredata 
noflashing  jsr flashpressfiretext
            rts

flashhiscoredata 
            jsr flashranks 
            jsr flashnames 
            jsr flashscores 
            jsr flashlineheader
            rts 

;Flash the his score data according to column position 
flashranks
            ldx #$00
franksloop1 lda ColourTempTable1
            sta TableColumn1,x 
            lda ColourTempTable1+1
            sta TableColumn1+1*40,x
            sta TableColumn1+8*40,x
            lda ColourTempTable1+2
            sta TableColumn1+2*40,x
            sta TableColumn1+9*40,x 
            lda ColourTempTable1+3
            sta TableColumn1+3*40,x 
            lda ColourTempTable1+4 
            sta TableColumn1+4*40,x 
            lda ColourTempTable1+5 
            sta TableColumn1+5*40,x 
            lda ColourTempTable1+6 
            sta TableColumn1+6*40,x 
            lda ColourTempTable1+7
            sta TableColumn1+7*40,x 
            inx 
            cpx #3
            bne franksloop1 
            rts 

flashnames  ldx #$00
fnameloop   lda ColourTempTable2
            sta TableColumn2+9*40,x 
            lda ColourTempTable2+1
            sta TableColumn2+1*40,x 
            sta TableColumn2+8*40,x 
            lda ColourTempTable2+2
            sta TableColumn2,x
            sta TableColumn2+7*40,x
            lda ColourTempTable2+3 
            sta TableColumn2+6*40,x 
            lda ColourTempTable2+4 
            sta TableColumn2+5*40,x 
            lda ColourTempTable2+5
            sta TableColumn2+4*40,x 
            lda ColourTempTable2+6
            sta TableColumn2+3*40,x 
            lda ColourTempTable2+7 
            sta TableColumn2+2*40,x 
            inx 
            cpx #09
            bne fnameloop
            rts 

flashscores
            ldx #$00
fscoresloop lda ColourTempTable3
            sta TableColumn3,x
            sta TableColumn3+8*40,x
            lda ColourTempTable3+1
            sta TableColumn3+1*40,x
            sta TableColumn3+9*40,x 
            lda ColourTempTable3+2
            sta TableColumn3+2*40,x 
            lda ColourTempTable3+3 
            sta TableColumn3+3*40,x 
            lda ColourTempTable3+4
            sta TableColumn3+4*40,x  
            lda ColourTempTable3+5
            sta TableColumn3+5*40,x  
            lda ColourTempTable3+6 
            sta TableColumn3+6*40,x 
            lda ColourTempTable3+7
            sta TableColumn3+7*40,x 
            inx 
            cpx #$06
            bne fscoresloop 
            rts 




            
            inx 
            cpx #$03
            bne fscoresloop
            rts

flashlineheader   

            ldx #$00
flashline1  lda colourstore4
            sta $d800+10*40,x 
            inx 
            cpx #40 
            bne flashline1
            rts 

flashpressfiretext
            ldx #$00
flashpf     lda colourstore1
            sta $db20,x 
            inx 
            cpx #$28
            bne flashpf 
            rts

TestSoundOption
            jsr TestJoyOption
            jsr CheckSoundOption
            rts 

TestJoyOption            

;Check joystick left (port 2)            
            lda #4
            bit $dc00 
            bne skip01 
so1         lda #0
            sta soundoption 
            rts
skip01      lda #8
            bit $dc00 
            bne skip02 
so2         lda #1
            sta soundoption 
            rts 
skip02      lda #4
            bit $dc01 
            bne skip03
            jmp so1 
skip03      lda #8
            bit $dc01 
            bne skip04 
            jmp so2 
skip04            
            rts 

CheckSoundOption
            lda soundoption
            beq MusicOnly
            jmp SetupSFX 
MusicOnly   lda colourstore3 
			sta $d027 
			lda #$02 
			sta $d028
            rts              
SetupSFX    lda #$02
            sta $d027 
            lda colourstore3
            sta $d028 
            rts





.titleJoystickTest
	; Wait for fire
	lda #%10000
	bit CIA1KeyboardColumnJoystickA
	beq .joystick0start
	bit CIA1KeyboardRowsJoystickB
	beq .joystick1start

	jmp .l3

.joystick0start
!ifdef Scroller_DisplayTitleScreen {
	lda #1
	sta TitleScreen_Enable_ScrollerDemoWait_Hooks
}

	lda #0
	sta TitleScreenJoystickStarted
	jmp InitGame

.joystick1start
!ifdef Scroller_DisplayTitleScreen {
	lda #1
	sta TitleScreen_Enable_ScrollerDemoWait_Hooks
}

	lda #1
	sta TitleScreenJoystickStarted
    jmp InitGame


; Converts a character to display it on the screen
.convertChar
	and #$3f
	cmp #$30
	bcc .ret
	clc
	adc #6
.ret
	rts

!ifdef TitleScreen_AnimatingSprites {
TitleScreen_SpriteAnimateCount !by 0
TitleScreen_SpriteAnimateCount2 !by 8
}

!zn
.spriteOffset0 = 32+32+32
.spriteOffset1 = 128
.spriteOffset2 = 128+32

; Spread evenly
.spriteSpread = 16
;.spriteSpread = 20
;.spritePerStroke = 12
;.spritePerStroke = 10
;.spritePerStroke = 8
.spritePerStroke = Multiplex_items / 2

; Very tight packing
;.spriteSpread = 8
;.spritePerStroke = 12
.xposTweak = 24

!if Multiplex_items < (.spritePerStroke * 2) {
!error "Not enough Multiplex_items for title screen sprite animation .spritePerStroke"
}

.upDownTab !by 0,1,2,3,4,5,6,7,7,6,5,4,3,2,1,0
TitleScreenAnimationHook
!ifdef TitleScreen_AnimatingSprites {
	inc TitleScreen_SpriteAnimateCount

	ldy TitleScreen_SpriteAnimateCount
	ldx #0
.l1
	; If something is already animating in this slot then continue with the animation
	lda Multiplex_YPos,x
	cmp #$ff
	bne .alreadyOn1
	; Otherwise calculate if the sprite is really small before allowing the animaton to start
	tya
	pha
	lsr
	lsr
	lsr
	lsr
	tay
	lda .upDownTab,y
	cmp #7
	bne .skipIt1
	pla
	tay
.alreadyOn1
	lda TitleScreen_SinTab,y
	sta Multiplex_YPos,x
!ifdef Multiplex_SplitSort {
	sta AnimationYPosToSort,x
}
	tya
	pha
	lsr
	lsr
	lsr
	lsr
	tay
	lda .upDownTab,y
	clc
	adc #$28
	sta Multiplex_SpriteFrame,x
.skipIt1
	pla
	clc
	adc #.spriteSpread
	tay
	inx
	cpx #.spritePerStroke
	bne .l1

	lda TitleScreen_SpriteAnimateCount
	clc
	adc #.spriteOffset0
	tay
	ldx #0
.l2
	lda TitleScreen_SinTab,y
	clc
	adc #.xposTweak
	sta Multiplex_XPosLo,x
	tya
	clc
	adc #.spriteSpread
	tay
	inx
	cpx #.spritePerStroke
	bne .l2

!if 1 {
	inc TitleScreen_SpriteAnimateCount2

	lda TitleScreen_SpriteAnimateCount2
	clc
	adc #.spriteOffset1
	tay
	ldx #0
.l3
	; If something is already animating in this slot then continue with the animation
	lda Multiplex_YPos+.spritePerStroke,x
	cmp #$ff
	bne .alreadyOn2
	; Otherwise calculate if the sprite is really small before allowing the animaton to start
	tya
	pha
	lsr
	lsr
	lsr
	lsr
	tay
	lda .upDownTab,y
	cmp #7
	bne .skipIt2
	pla
	tay
.alreadyOn2
	lda TitleScreen_SinTab,y
	sta Multiplex_YPos+.spritePerStroke,x
!ifdef Multiplex_SplitSort {
	sta AnimationYPosToSort+.spritePerStroke,x
}
	tya
	pha
	lsr
	lsr
	lsr
	lsr
	tay
	lda .upDownTab,y
	clc
	adc #$28
	sta Multiplex_SpriteFrame+.spritePerStroke,x
.skipIt2
	pla
	clc
	adc #.spriteSpread
	tay
	inx
	cpx #.spritePerStroke
	bne .l3

	lda TitleScreen_SpriteAnimateCount2
	clc
	adc #.spriteOffset2
	tay
	ldx #0
.l4
	lda TitleScreen_SinTab,y
	clc
	adc #.xposTweak
	sta Multiplex_XPosLo+.spritePerStroke,x
	tya
	clc
	adc #.spriteSpread
	tay
	inx
	cpx #.spritePerStroke
	bne .l4
}

} else {
	; Initialise the sprite registers to something simple
	lda #0
;	lda #50	; Display the sprite on the screen
	sta Multiplex_YPos
!ifdef Multiplex_SplitSort {
	sta AnimationYPosToSort
}
	; Move it
	lda Multiplex_XPosLo
	clc
	adc #10
	sta Multiplex_XPosLo
	sta Multiplex_Colour
	lda #0
	sta Multiplex_XPosHi
}
	; After this function returns the mutiplexor will sort the sprites and display them
	rts

TitleScreenJoystickStarted !by 0

!ifdef Scroller_LOTD {
TitleScreenWaitForMessageRaster
	lda #$e8
.rl1
	cmp VIC2Raster
	bne .rl1
	; Stop the random wobbling 8 pixel mess from appearing by setting the screen to be black
	; temporarily.
	lda VIC2ScreenColour
	ldy #0
	sty VIC2ScreenColour
	ldy MessageScrollX
	sty VIC2ScreenControlH
	sta VIC2ScreenColour
	rts
}

!zn
; This should be used with the IRQs disabled to stop any IRQ from using that screen raster time.
; For example:
; Wait for the raster so that turning off the screen is done with a clean effect rather than
; producing a couple of lines of rubbish data.
TitleScreenWaitForOffScreenFromRaster
	lda #$ff
.l2
	cmp VIC2Raster
	bne .l2	
	rts

;---------------------------------------------------
;Title screen scroll text (We should change the font
;for this.
;--------------------------------------------------
!ifdef Scroller_LOTD {
ScrollMessageUpdate
	lda MessageScrollX
	sec 
	sbc #$01
	and #$07
	sta MessageScrollX
	bcs .retScroll
	ldx #$00
.copytext
	lda SCREENRAM+(23*40)+1,x
	sta SCREENRAM+(23*40),x
	inx
	cpx #40
	bne .copytext
smMessageReadPos lda ScrollText
	cmp #$00
	bne .storeChar
	lda #<ScrollText
	sta smMessageReadPos+1
	lda #>ScrollText
	sta smMessageReadPos+2
	jmp smMessageReadPos
.storeChar
	sta SCREENRAM+(23*40)+39
	inc smMessageReadPos+1
	bne .retScroll
	inc smMessageReadPos+2
.retScroll
	rts
}
ClearScreen
clearscreen 

	ldx #$00
.l1	
	lda #$20
	sta SCREENRAM,x
	sta SCREENRAM + $100,x
	sta SCREENRAM + $200,x
	sta SCREENRAM + $2e8,x
	lda #$0b
	sta COLOURRAM,x
	sta COLOURRAM + $100,x
	sta COLOURRAM + $200,x
	sta COLOURRAM + $2e8,x
	inx
	bne .l1
	rts

;Game over 


GameOverScreen

            jsr KillIRQ
            jsr ClearScreen
			jsr DelayRoutine
            
           ; jsr WaitDelayRoutine
            lda #6
            sta $d020 
            sta $d021

            ldx #$00
CopyGameOverText 
            lda GameOverText,x 
            sta $05e0,x 
            lda #$03
            sta $d9e0,x 
            inx 
            cpx #40
            bne CopyGameOverText 

            lda #0
            sta firebutton

			lda #4 
			jsr MusicInit
            jsr SetupSingleIRQ
            


GameOverLoop 

            jsr SyncTimer
            jsr ColourCycle
            ldx #$00
plotloop2   lda colourstore1 
            sta $d9e0,x 
            inx 
            cpx #40
            bne plotloop2

            lda $dc00 
            lsr
            lsr 
            lsr 
            lsr 
            lsr 
            bit firebutton
            ror firebutton
            bmi GameOverLoop2 
            bvc GameOverLoop2
            jmp CheckHiScore
GameOverLoop2 
            lda $dc01 
            lsr
            lsr
            lsr
            lsr
            lsr 
            bit firebutton
            ror firebutton
            bmi GameOverLoop
            bvc GameOverLoop 
            jmp CheckHiScore 

EndScreen   
            jsr KillIRQ
			 lda #6
            sta $d020 
            sta $d021

            jsr ClearScreen
            jsr DelayRoutine

           
            ;Copy end text to screen

            ldx #$00
WellDoneTextLoop  
            lda WellDoneText,x
            sta $0518,x 
            lda WellDoneText+1*40,x 
            sta $0518+40,x 
            lda WellDoneText+2*40,x 
            sta $0518+2*40,x 
            lda WellDoneText+3*40,x 
            sta $0518+3*40,x 
            lda WellDoneText+4*40,x 
            sta $0518+4*40,x 
            lda WellDoneText+5*40,x 
            sta $0518+5*40,x 
            lda WellDoneText+6*40,x 
            sta $0518+6*40,x 
            lda WellDoneText+7*40,x 
            sta $0518+7*40,x 
            lda WellDoneText+8*40,x 
            sta $0518+8*40,x 
            lda WellDoneText+9*40,x 
            sta $0518+9*40,x 
            lda WellDoneText+10*40,x 
            sta $0518+10*40,x 
            lda WellDoneText+11*40,x 
            sta $0518+11*40,x 
            lda #$01
            sta $d918,x 
            sta $d918+40,x 
            sta $d918+2*40,x 
            sta $d918+3*40,x 
            sta $d918+4*40,x 
            sta $d918+5*40,x 
            sta $d918+6*40,x 
            sta $d918+7*40,x 
            sta $d918+8*40,x 
            sta $d918+9*40,x 
            sta $d918+10*40,x 
            sta $d918+11*40,x 
            
            inx 
            cpx #40 
            beq welldoneready
            jmp WellDoneTextLoop
welldoneready
            jsr SetupSingleIRQ
            
            lda #$02 ;Well done and hi score music 
            
            jsr MusicInit
            cli
            lda #0
            sta firebutton
EndScreenLoop 
            jsr SyncTimer
            jsr ColourCycle
            ldx #$00
flashwd     lda colourstore4
            sta $d918,x 
            inx 
            cpx #$28
            bne flashwd
            lda $dc00 
            lsr
            lsr
            lsr
            lsr
            lsr 
            bit firebutton
            ror firebutton
            bmi EndScreenLoop2
            bvc EndScreenLoop2 
            jmp CheckHiScore
EndScreenLoop2 
            lda $dc01 
            lsr 
            lsr 
            lsr 
            lsr 
            lsr 
            bit firebutton
            ror firebutton
            bmi EndScreenLoop
            bvc EndScreenLoop
            jmp CheckHiScore                               

CheckHiScore 
            jsr fadeoutmode
            jmp HiScoreChecker

DelayRoutine ldx #$00
DelayLoop1   ldy #$00
DelayLoop2   iny 
             bne DelayLoop2 
			 inx 
			 bne DelayLoop1
			 rts
fadeoutmode 

   ldx #$00
cleardat    
    ldy #$00    
cleardat2 
    lda #$06
    sta $d800,x 
    sta $d900,x 
    sta $da00,x 
    sta $dae8,x    
    iny 
    bne cleardat2
    inx 
    inx
    inx 
    inx 
    inx
    inx 
    inx
    bne cleardat 


            
;Music fader routine 
    lda #$0f 
    sta $fe
WaitingLoop
    ldx #$00
WaitingLoop2    
    ldy #$00
WaitingLoop3    
    iny
    iny 
    bne WaitingLoop3
    inx
    inx
    bne WaitingLoop2
    dec $fe 
    lda $fe 
    cmp #$00
    beq finishedmusicfade 
    jsr MusicPlayerInit+6
    jmp WaitingLoop 
finishedmusicfade
    rts

;
sequence !byte 0
firebutton !byte 0
rt !byte 0
xpos !byte 0
pagedelay !byte 0,0
pagevalue !byte 0
colourdelay !byte 0
colourpointer !byte 0 
colourstore1 !byte 0
colourstore2 !byte 0
colourstore3 !byte 0
colourstore4 !byte 0
soundoption  !byte 0
postable !byte $0e,$e8,$9d,$e8,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
objpos !byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
 !align $ff,$00
d016table       ;Wobbling table generated from Wixbouncer
     
      !byte 23,22,22,22,21,21
      !byte 20,20,19,19,19,18
      !byte 18,18,17,17,17,17
      !byte 17,17,17,18,18,18
      !byte 19,19,20,20,21,21
      !byte 21,22,22,22,23,23
      !byte 23,23,23,23,23,22
      !byte 22,22,21,21,20,20
      !byte 19,19,19,18,18,18
      !byte 17,17,17,17,17,17
      !byte 17,18,18,18,19,19
      !byte 20,20,21,21,21,22
      !byte 22,22,23,23,23,23
      !byte 23,23


;Colour table data for flash/fading 

ColourTable1 !byte $06,$04,$0e,$03,$01,$03,$0e,$04
ColourTable2 !byte $06,$05,$03,$0d,$01,$0d,$03,$05
ColourTable3 !byte $06,$0c,$0f,$07,$01,$07,$0f,$0c
ColourTable4 !byte $01,$0d,$03,$0e,$06,$0e,$03,$0d
ColourTempTable1 !byte 0,0,0,0,0,0,0,0
ColourTempTable2 !byte 0,0,0,0,0,0,0,0
ColourTempTable3 !byte 0,0,0,0,0,0,0,0

;Add a scrolling message to the titlescreen

!ifdef Scroller_LOTD {

ScrollText	

!scr "=== welcome to legion of the damned brought to you by"
!scr " anthony burns= with enhancements by martin piper "
!scr "and richard bayliss === music by richard ba"
!scr "yliss === "
!scr "the formerly peaceful village of hameria has been"
!scr " taken over by a horde of evil vampiresses= demons= and"
!scr " their undead minions= led by queen stryxia === in a"
!scr " last ditch attempt to free themselves= the opress"
!scr "ed people hire mercenary fighters === either the s"
!scr "word wielding amazon with her whirlwind spells or"
!scr " the axe throwing barbarian with his meteor spell"
!scr "s or both fighters === they can replenish their he"
!scr "alth and magic powers with blue potions === the "
!scr "more potions they hold at once= which could be up "
!scr "to three the more powerful their magic will be ===  "
!scr "joystick port 7 controls the barbarian also to "
!scr "use the meteor spells press the k key === joystick"
!scr " port z controls the amazon also to use the whi"
!scr "rlwind spells press the s key  === all spells work l"
!scr "ike a smart bomb which will kill all enemies on s"
!scr "creen === press fire to play and enjoy this epic sideways seuck adventure ===                 "
!scr "                                          @"
}


!ifdef TitleScreen_AnimatingSprites {
TitleScreen_SinTab
 !by $8d,$8f,$92,$94,$96,$98,$9a,$9c,$9f,$a1,$a3,$a5,$a7,$a9,$ab,$ad
 !by $af,$b1,$b3,$b5,$b7,$b9,$bb,$bc,$be,$c0,$c2,$c3,$c5,$c7,$c8,$ca
 !by $cb,$cd,$ce,$d0,$d1,$d2,$d4,$d5,$d6,$d7,$d8,$d9,$da,$db,$dc,$dd
 !by $de,$df,$e0,$e0,$e1,$e1,$e2,$e2,$e3,$e3,$e3,$e4,$e4,$e4,$e4,$e4
 !by $e4,$e4,$e4,$e4,$e3,$e3,$e3,$e2,$e2,$e1,$e1,$e0,$e0,$df,$de,$dd
 !by $dc,$db,$da,$d9,$d8,$d7,$d6,$d5,$d4,$d2,$d1,$d0,$ce,$cd,$cb,$ca
 !by $c8,$c7,$c5,$c3,$c2,$c0,$be,$bc,$bb,$b9,$b7,$b5,$b3,$b1,$af,$ad
 !by $ab,$a9,$a7,$a5,$a3,$a1,$9f,$9c,$9a,$98,$96,$94,$92,$8f,$8d,$8b
 !by $89,$87,$84,$82,$80,$7e,$7c,$7a,$77,$75,$73,$71,$6f,$6d,$6b,$69
 !by $67,$65,$63,$61,$5f,$5d,$5b,$5a,$58,$56,$54,$53,$51,$4f,$4e,$4c
 !by $4b,$49,$48,$46,$45,$44,$42,$41,$40,$3f,$3e,$3d,$3c,$3b,$3a,$39
 !by $38,$37,$36,$36,$35,$35,$34,$34,$33,$33,$33,$32,$32,$32,$32,$32
 !by $32,$32,$32,$32,$33,$33,$33,$34,$34,$35,$35,$36,$36,$37,$38,$39
 !by $3a,$3b,$3c,$3d,$3e,$3f,$40,$41,$42,$44,$45,$46,$48,$49,$4b,$4c
 !by $4e,$4f,$51,$53,$54,$56,$58,$5a,$5b,$5d,$5f,$61,$63,$65,$67,$69
 !by $6b,$6d,$6f,$71,$73,$75,$77,$7a,$7c,$7e,$80,$82,$84,$87,$89,$8b
}
